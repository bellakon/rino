{% extends "base.html" %}

{% block title %}Bitácora - RINO{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-journal-check"></i> Procesamiento de Bitácora</h2>
            <p class="text-muted">Genera bitácora de asistencias procesando checadas vs horarios asignados</p>
        </div>
    </div>

    <!-- Wizard de Steps -->
    <div class="card shadow-sm">
        <div class="card-body">
            <!-- Nav Tabs -->
            <ul class="nav nav-pills mb-4" id="bitacoraTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" 
                            data-bs-target="#step1" type="button" role="tab">
                        <i class="bi bi-person-check"></i> 1. Seleccionar Trabajador
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link disabled" id="step2-tab" data-bs-toggle="pill" 
                            data-bs-target="#step2" type="button" role="tab">
                        <i class="bi bi-calendar-range"></i> 2. Rango de Fechas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link disabled" id="step3-tab" data-bs-toggle="pill" 
                            data-bs-target="#step3" type="button" role="tab">
                        <i class="bi bi-play-circle"></i> 3. Procesar
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="bitacoraTabContent">
                <!-- Step 1: Seleccionar Trabajador -->
                <div class="tab-pane fade show active" id="step1" role="tabpanel">
                    <h5 class="mb-3">Selecciona el trabajador</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="selectTrabajador" class="form-label">Trabajador</label>
                                <select class="form-select" id="selectTrabajador" required>
                                    <option value="">Cargando trabajadores...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> <strong>Reporte Individual:</strong> Selecciona un trabajador para generar su reporte.
                        <br><small>¿Necesitas generar reportes de varios trabajadores? 
                        <a href="#" onclick="mostrarSeleccionMasiva(); return false;" class="alert-link">Haz clic aquí para selección masiva</a></small>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" onclick="irAStep2()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 1B: Selección Masiva (oculto por defecto) -->
                <div class="tab-pane fade" id="step1b" role="tabpanel">
                    <h5 class="mb-3">Selecciona múltiples trabajadores</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="buscarTrabajadorMasivo" 
                                   placeholder="Buscar por número o nombre...">
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="seleccionarTodos()">
                                <i class="bi bi-check-all"></i> Seleccionar Todos
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deseleccionarTodos()">
                                <i class="bi bi-x-circle"></i> Deseleccionar Todos
                            </button>
                        </div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                        <div id="listaTrabajadoresMasivo">
                            <p class="text-muted">Cargando trabajadores...</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-success mt-3" id="resumenSeleccion" style="display: none;">
                        <strong>Trabajadores seleccionados:</strong> <span id="contadorSeleccionados">0</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-secondary" onclick="volverAIndividual()">
                            <i class="bi bi-arrow-left"></i> Volver a Reporte Individual
                        </button>
                        <button type="button" class="btn btn-primary" id="btnSiguienteMasivo">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Rango de Fechas -->
                <div class="tab-pane fade" id="step2" role="tabpanel">
                    <h5 class="mb-3">Define el rango de fechas</h5>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                                <input type="date" class="form-control" id="fechaInicio" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fechaFin" class="form-label">Fecha Fin</label>
                                <input type="date" class="form-control" id="fechaFin" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <button type="button" class="btn btn-info" onclick="verificarHorario()">
                            <i class="bi bi-clock"></i> Verificar Horario Asignado
                        </button>
                    </div>

                    <!-- Info de Horario -->
                    <div id="infoHorario" class="alert alert-info d-none">
                        <h6><i class="bi bi-info-circle"></i> Horario Asignado:</h6>
                        <div id="detalleHorario"></div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="irAStep1()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="irAStep3()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Procesar -->
                <div class="tab-pane fade" id="step3" role="tabpanel">
                    <h5 class="mb-3">Resumen y Procesamiento</h5>
                    
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title">Datos a procesar:</h6>
                            <ul class="mb-0">
                                <li><strong>Trabajador:</strong> <span id="resumenTrabajador"></span></li>
                                <li><strong>Periodo:</strong> <span id="resumenPeriodo"></span></li>
                            </ul>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Nota:</strong> Este proceso comparará las checadas con los horarios asignados 
                        y calculará las incidencias automáticamente según las reglas configuradas.
                    </div>

                    <div class="mb-4">
                        <button type="button" class="btn btn-success btn-lg" onclick="procesarBitacora()" id="btnProcesar">
                            <i class="bi bi-gear-fill"></i> Procesar Bitácora
                        </button>
                    </div>

                    <!-- Resultados -->
                    <div id="resultados" class="d-none">
                        <h5 class="mb-3">Resultados del Procesamiento</h5>
                        <div id="mensajeResultado" class="alert"></div>
                        <p class="text-muted small"><i class="bi bi-info-circle"></i> Doble click en una fila para editar el registro</p>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="tablaResultados">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Departamento</th>
                                        <th>Horario</th>
                                        <th>Código</th>
                                        <th>Movimiento</th>
                                        <th>Checada 1</th>
                                        <th>Checada 2</th>
                                        <th>Checada 3</th>
                                        <th>Checada 4</th>
                                        <th>Minutos Retardo</th>
                                        <th>Horas Trabajadas</th>
                                        <th>Descripción</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyResultados"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="irAStep2()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <div>
                            <button type="button" class="btn btn-primary" onclick="generarPDF()" id="btnGenerarPDF" style="display: none;">
                                <i class="bi bi-file-earmark-pdf"></i> Descargar PDF Individual
                            </button>
                            <button type="button" class="btn btn-success" onclick="generarPDFMasivo()" id="btnGenerarPDFMasivo" style="display: none;">
                                <i class="bi bi-file-earmark-pdf-fill"></i> Descargar PDF Masivo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Resultados Masivos -->
<div class="modal fade" id="modalResultadosMasivos" tabindex="-1" aria-labelledby="modalResultadosMasivosLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalResultadosMasivosLabel">
                    <i class="bi bi-check-circle"></i> Resultados del Procesamiento Masivo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Resumen de totales -->
                <div class="alert alert-info" id="resumenMasivo">
                    <h6><i class="bi bi-info-circle"></i> Resumen</h6>
                    <div id="resumenMasivoDetalle"></div>
                </div>
                
                <!-- Tabla de resultados por trabajador -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Trabajador</th>
                                <th>Nombre</th>
                                <th>Estado</th>
                                <th>Nuevos</th>
                                <th>Actualizados</th>
                                <th>Total Días</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyResultadosMasivos">
                            <!-- Se llena dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edición de Registro -->
<div class="modal fade" id="modalEditarRegistro" tabindex="-1" aria-labelledby="modalEditarRegistroLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="modalEditarRegistroLabel">
                    <i class="bi bi-pencil-square"></i> Editar Registro de Bitácora
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarRegistro">
                    <input type="hidden" id="editRegistroId">
                    
                    <!-- Info del registro (solo lectura) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted">Trabajador</label>
                            <p class="form-control-plaintext" id="editNombreTrabajador"></p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted">Fecha</label>
                            <p class="form-control-plaintext" id="editFecha"></p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted">Horario</label>
                            <p class="form-control-plaintext" id="editHorario"></p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Incidencia actual (solo lectura) -->
                    <div class="alert alert-secondary mb-3">
                        <strong>Incidencia Actual:</strong> 
                        <span id="editCodigoActual" class="badge bg-secondary"></span>
                        <span id="editTipoMovActual"></span>
                        <br>
                        <small id="editDescripcionActual"></small>
                    </div>
                    
                    <!-- Checadas editables -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="editChecada1" class="form-label">Checada 1 (Entrada)</label>
                            <input type="time" class="form-control" id="editChecada1" step="1">
                            <small class="text-muted">HH:MM</small>
                        </div>
                        <div class="col-md-3">
                            <label for="editChecada2" class="form-label">Checada 2 (Salida)</label>
                            <input type="time" class="form-control" id="editChecada2" step="1">
                            <small class="text-muted">HH:MM</small>
                        </div>
                        <div class="col-md-3">
                            <label for="editChecada3" class="form-label">Checada 3</label>
                            <input type="time" class="form-control" id="editChecada3" step="1">
                            <small class="text-muted">Opcional</small>
                        </div>
                        <div class="col-md-3">
                            <label for="editChecada4" class="form-label">Checada 4</label>
                            <input type="time" class="form-control" id="editChecada4" step="1">
                            <small class="text-muted">Opcional</small>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Protección del registro -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editUpdatable" checked>
                            <label class="form-check-label" for="editUpdatable">
                                <strong>Permitir actualizaciones automáticas</strong>
                            </label>
                        </div>
                        <small class="text-muted">
                            Si está desactivado, este registro NO será modificado cuando se reprocese la bitácora.
                            Útil para correcciones manuales que deben preservarse.
                        </small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Al guardar, la incidencia se recalculará automáticamente según las checadas ingresadas y las reglas del sistema.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarEdicionRegistro()">
                    <i class="bi bi-save"></i> Guardar y Recalcular
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let trabajadorSeleccionado = null;
let modoMasivo = false;
let trabajadoresSeleccionados = [];
let registrosProcesados = [];
let datosGeneralesPDF = {};
let horariosValidados = false; // Nueva variable para rastrear validación en modo masivo

// Función para obtener día de semana en español
function obtenerDiaSemana(fechaStr) {
    const dias = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
    const fecha = new Date(fechaStr + 'T00:00:00');
    return dias[fecha.getDay()];
}

// Cargar trabajadores al inicio
document.addEventListener('DOMContentLoaded', function() {
    cargarTrabajadores();
    
    // Configurar event listener para el botón siguiente masivo
    const btnSiguienteMasivo = document.getElementById('btnSiguienteMasivo');
    if (btnSiguienteMasivo) {
        btnSiguienteMasivo.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('[BITACORA] Click en btnSiguienteMasivo');
            console.log('[BITACORA] Trabajadores seleccionados antes de avanzar:', trabajadoresSeleccionados);
            irAStep2Masivo();
        });
    } else {
        console.error('[BITACORA] No se encontró btnSiguienteMasivo');
    }
    
    // Resetear validación cuando cambien las fechas en modo masivo
    const fechaInicio = document.getElementById('fechaInicio');
    const fechaFin = document.getElementById('fechaFin');
    
    if (fechaInicio) {
        fechaInicio.addEventListener('change', function() {
            if (modoMasivo) {
                horariosValidados = false;
                const infoHorario = document.getElementById('infoHorario');
                if (infoHorario) {
                    infoHorario.classList.add('d-none');
                }
            }
        });
    }
    
    if (fechaFin) {
        fechaFin.addEventListener('change', function() {
            if (modoMasivo) {
                horariosValidados = false;
                const infoHorario = document.getElementById('infoHorario');
                if (infoHorario) {
                    infoHorario.classList.add('d-none');
                }
            }
        });
    }
});

async function cargarTrabajadores() {
    try {
        console.log('[BITACORA] Iniciando carga de trabajadores');
        const response = await fetch('/trabajadores/listar');
        console.log('[BITACORA] Response status:', response.status);
        
        const data = await response.json();
        console.log('[BITACORA] Response data:', data);
        
        const select = document.getElementById('selectTrabajador');
        select.innerHTML = '<option value="">Selecciona un trabajador...</option>';
        
        // La respuesta puede ser { trabajadores: [...] } o { success: true, trabajadores: [...] }
        const trabajadores = data.trabajadores || data;
        
        if (trabajadores && Array.isArray(trabajadores)) {
            console.log('[BITACORA] Trabajadores encontrados:', trabajadores.length);
            trabajadores.forEach(t => {
                const option = document.createElement('option');
                option.value = t.num_trabajador;
                option.textContent = `${t.num_trabajador} - ${t.nombre || 'Sin nombre'}`;
                option.dataset.nombre = t.nombre || 'Sin nombre';
                select.appendChild(option);
            });
            console.log('[BITACORA] Trabajadores cargados exitosamente');
        } else {
            console.warn('[BITACORA] No se encontraron trabajadores en la respuesta:', data);
        }
    } catch (error) {
        console.error('[BITACORA] Error al cargar trabajadores:', error);
        mostrarToast('Error al cargar trabajadores', 'error');
    }
}

function irAStep1() {
    document.getElementById('step1-tab').click();
}

function irAStep2() {
    const select = document.getElementById('selectTrabajador');
    if (!select.value) {
        mostrarToast('Selecciona un trabajador primero', 'warning');
        return;
    }
    
    trabajadorSeleccionado = {
        num_trabajador: select.value,
        nombre: select.options[select.selectedIndex].dataset.nombre
    };
    
    document.getElementById('step2-tab').classList.remove('disabled');
    document.getElementById('step2-tab').click();
}

function irAStep3() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    if (!fechaInicio || !fechaFin) {
        mostrarToast('Define el rango de fechas', 'warning');
        return;
    }
    
    if (fechaInicio > fechaFin) {
        mostrarToast('La fecha inicio no puede ser mayor a la fecha fin', 'warning');
        return;
    }
    
    // Validación adicional para modo masivo
    if (modoMasivo && !horariosValidados) {
        mostrarToast('Debe verificar los horarios antes de continuar', 'warning');
        return;
    }
    
    // Actualizar resumen dependiendo del modo
    if (modoMasivo) {
        // Modo masivo
        document.getElementById('resumenTrabajador').textContent = 
            `${trabajadoresSeleccionados.length} trabajadores seleccionados`;
        document.getElementById('resumenPeriodo').textContent = 
            `${fechaInicio} al ${fechaFin}`;
    } else {
        // Modo individual
        if (trabajadorSeleccionado) {
            document.getElementById('resumenTrabajador').textContent = 
                `${trabajadorSeleccionado.num_trabajador} - ${trabajadorSeleccionado.nombre}`;
            document.getElementById('resumenPeriodo').textContent = 
                `${fechaInicio} al ${fechaFin}`;
        } else {
            mostrarToast('No hay trabajador seleccionado', 'error');
            return;
        }
    }
    
    document.getElementById('step3-tab').classList.remove('disabled');
    document.getElementById('step3-tab').click();
}

async function verificarHorario() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    if (!fechaInicio || !fechaFin) {
        mostrarToast('Define primero el rango de fechas', 'warning');
        return;
    }
    
    try {
        // Verificar si es modo masivo o individual
        if (modoMasivo) {
            console.log('[BITACORA] Verificando horarios para', trabajadoresSeleccionados.length, 'trabajadores');
            
            // Resetear validación
            horariosValidados = false;
            
            const trabajadoresSinHorario = [];
            const trabajadoresConHorario = [];
            
            // Verificar horario de cada trabajador seleccionado
            for (const numTrabajador of trabajadoresSeleccionados) {
                const response = await fetch('/bitacora/horario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        num_trabajador: numTrabajador,
                        fecha_inicio: fechaInicio,
                        fecha_fin: fechaFin
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    trabajadoresConHorario.push({
                        num: numTrabajador,
                        horario: data.horario
                    });
                } else {
                    trabajadoresSinHorario.push(numTrabajador);
                }
            }
            
            const infoHorario = document.getElementById('infoHorario');
            const detalleHorario = document.getElementById('detalleHorario');
            
            if (trabajadoresSinHorario.length > 0) {
                // Mostrar error con los trabajadores que NO tienen horario
                let html = '<div class="alert alert-danger">';
                html += '<h6>⚠️ Los siguientes trabajadores NO tienen horario asignado:</h6>';
                html += '<ul class="mb-0">';
                trabajadoresSinHorario.forEach(num => {
                    html += '<li>Trabajador #' + num + '</li>';
                });
                html += '</ul>';
                html += '<p class="mt-2 mb-0"><strong>No podrá continuar hasta que todos los trabajadores tengan horario asignado en estas fechas.</strong></p>';
                html += '</div>';
                
                if (trabajadoresConHorario.length > 0) {
                    html += '<div class="alert alert-success mt-2">';
                    html += '<h6>✅ Trabajadores con horario asignado:</h6>';
                    html += '<ul class="mb-0">';
                    trabajadoresConHorario.forEach(t => {
                        html += '<li>Trabajador #' + t.num + ' - ' + t.horario.horario_nombre + '</li>';
                    });
                    html += '</ul>';
                    html += '</div>';
                }
                
                detalleHorario.innerHTML = html;
                infoHorario.classList.remove('d-none');
                
                // NO permitir avanzar
                horariosValidados = false;
                mostrarToast(trabajadoresSinHorario.length + ' trabajadores sin horario. No puede continuar.', 'error');
                
            } else {
                // Todos tienen horario - PERMITIR avanzar
                horariosValidados = true;
                
                let html = '<div class="alert alert-success">';
                html += '<h6>✅ Todos los trabajadores (' + trabajadoresConHorario.length + ') tienen horario asignado</h6>';
                html += '<ul class="mb-0">';
                trabajadoresConHorario.forEach(t => {
                    const nomenclatura = t.horario.turno_nomenclatura || 'N/A';
                    html += '<li>Trabajador #' + t.num + ' - ' + t.horario.horario_nombre + ' (' + nomenclatura + ')</li>';
                });
                html += '</ul>';
                html += '<p class="mt-2 mb-0 text-success"><strong><i class="bi bi-check-circle"></i> Puede continuar al siguiente paso.</strong></p>';
                html += '</div>';
                
                detalleHorario.innerHTML = html;
                infoHorario.classList.remove('d-none');
                
                mostrarToast('Todos los trabajadores tienen horario asignado', 'success');
            }
            
        } else {
            // Modo individual (código original)
            console.log('[BITACORA] Verificando horario para trabajador:', trabajadorSeleccionado.num_trabajador);
            const response = await fetch('/bitacora/horario', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    num_trabajador: trabajadorSeleccionado.num_trabajador,
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin
                })
            });
            
            console.log('[BITACORA] Response status:', response.status);
            const data = await response.json();
            console.log('[BITACORA] Horario response:', data);
            
            if (data.success) {
                const horario = data.horario;
                const infoHorario = document.getElementById('infoHorario');
                const detalleHorario = document.getElementById('detalleHorario');
                
                console.log('[BITACORA] Horario recibido:', horario);
                
                const nomenclatura = horario.turno_nomenclatura || 'N/A';
                const fechaFin = horario.fecha_fin_asignacion || 'Vigente';
                
                let html = '<ul class="mb-0">';
                html += '<li><strong>Turno:</strong> ' + horario.horario_nombre + ' (' + nomenclatura + ')</li>';
                html += '<li><strong>Fecha Inicio:</strong> ' + horario.fecha_inicio_asignacion + '</li>';
                html += '<li><strong>Fecha Fin:</strong> ' + fechaFin + '</li>';
                html += '<li><strong>Horarios por día:</strong></li>';
                html += '<ul>';
                
                const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                for (let i = 0; i < 7; i++) {
                    if (horario.horarios_por_dia && horario.horarios_por_dia[i]) {
                        html += '<li><strong>' + diasSemana[i] + ':</strong> ' + horario.horarios_por_dia[i] + '</li>';
                    }
                }
                
                html += '</ul></ul>';
                
                detalleHorario.innerHTML = html;
                infoHorario.classList.remove('d-none');
                console.log('[BITACORA] Horario mostrado exitosamente');
            } else {
                console.error('[BITACORA] Error en horario:', data.message);
                mostrarToast(data.message, 'error');
            }
        }
    } catch (error) {
        console.error('[BITACORA] Error al verificar horario:', error);
        mostrarToast('Error al verificar horario', 'error');
    }
}

async function procesarBitacora() {
    const btnProcesar = document.getElementById('btnProcesar');
    btnProcesar.disabled = true;
    btnProcesar.innerHTML = '<i class="bi bi-hourglass-split"></i> Procesando...';
    
    try {
        console.log('[BITACORA] Iniciando procesamiento de bitácora');
        
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        
        // Verificar modo
        if (modoMasivo) {
            // Modo masivo - procesar múltiples trabajadores
            console.log('[BITACORA] Modo masivo - procesando', trabajadoresSeleccionados.length, 'trabajadores');
            
            const response = await fetch('/bitacora/procesar-masivo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    num_trabajadores: trabajadoresSeleccionados,
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin
                })
            });
            
            const data = await response.json();
            console.log('[BITACORA] Respuesta procesamiento masivo:', data);
            
            if (data.success) {
                // Mostrar modal con resultados
                mostrarModalResultadosMasivos(data.resultados, data.totales, fechaInicio, fechaFin);
                mostrarToast(data.message, 'success');
            } else {
                mostrarToast(data.message, 'error');
            }
            
            btnProcesar.disabled = false;
            btnProcesar.innerHTML = '<i class="bi bi-gear-fill"></i> Procesar Bitácora';
            return;
        }
        
        // Modo individual
        if (!trabajadorSeleccionado) {
            mostrarToast('No hay trabajador seleccionado', 'error');
            btnProcesar.disabled = false;
            btnProcesar.innerHTML = '<i class="bi bi-gear-fill"></i> Procesar Bitácora';
            return;
        }
        
        const response = await fetch('/bitacora/procesar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                num_trabajador: trabajadorSeleccionado.num_trabajador,
                fecha_inicio: fechaInicio,
                fecha_fin: fechaFin
            })
        });
        
        console.log('[BITACORA] Response status:', response.status);
        const data = await response.json();
        console.log('[BITACORA] Procesar response:', data);
        
        if (data.success) {
            mostrarResultados(data.registros, data.message, data.stats);
            mostrarToast(data.message, 'success');
            console.log('[BITACORA] Bitácora procesada exitosamente', data.stats);
        } else {
            console.error('[BITACORA] Error en procesamiento:', data.message);
            mostrarToast(data.message, 'error');
        }
    } catch (error) {
        console.error('[BITACORA] Error al procesar bitácora:', error);
        mostrarToast('Error al procesar bitácora', 'error');
    } finally {
        btnProcesar.disabled = false;
        btnProcesar.innerHTML = '<i class="bi bi-gear-fill"></i> Procesar Bitácora';
    }
}

function mostrarResultados(registros, mensaje, stats) {
    const mensajeResultado = document.getElementById('mensajeResultado');
    mensajeResultado.className = 'alert alert-success';
    
    // Construir mensaje con estadísticas
    let mensajeHtml = '<strong>' + mensaje + '</strong>';
    if (stats) {
        mensajeHtml += '<br><small class="mt-2 d-block">';
        if (stats.insertados > 0) {
            mensajeHtml += '<i class="bi bi-plus-circle text-success"></i> ' + stats.insertados + ' nuevos | ';
        }
        if (stats.actualizados > 0) {
            mensajeHtml += '<i class="bi bi-arrow-repeat text-info"></i> ' + stats.actualizados + ' actualizados | ';
        }
        if (stats.bloqueados > 0) {
            mensajeHtml += '<i class="bi bi-lock-fill text-warning"></i> ' + stats.bloqueados + ' protegidos | ';
        }
        if (stats.errores > 0) {
            mensajeHtml += '<i class="bi bi-exclamation-triangle text-warning"></i> ' + stats.errores + ' errores | ';
        }
        mensajeHtml += '<i class="bi bi-calendar-check"></i> Total: ' + registros.length + ' días procesados';
        mensajeHtml += '</small>';
    }
    mensajeResultado.innerHTML = mensajeHtml;
    
    const tbody = document.getElementById('tbodyResultados');
    tbody.innerHTML = '';
    
    registros.forEach(reg => {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.setAttribute('data-registro-id', reg.id);
        
        // Agregar evento de doble click para editar
        tr.addEventListener('dblclick', function() {
            abrirModalEdicion(reg.id);
        });
        
        // Columna Movimientos: mostrar tipo_movimiento según el código
        let movimientoTexto = '-';
        if (reg.codigo_incidencia === 'F' && reg.tipo_movimiento) {
            // Si es falta, mostrar el tipo de falta (FNA, FRT, FST, FET)
            movimientoTexto = `<span class="badge bg-danger">${reg.tipo_movimiento}</span>`;
        } else if (reg.tipo_movimiento && (reg.codigo_incidencia === 'J' || reg.codigo_incidencia === 'L' || reg.codigo_incidencia === 'A')) {
            // Si es justificado, licencia o asistencia especial, mostrar el tipo de movimiento
            movimientoTexto = reg.tipo_movimiento;
        }
        
        tr.innerHTML = `
            <td><strong>${obtenerDiaSemana(reg.fecha)}</strong> ${reg.fecha}</td>
            <td><small>${reg.departamento || '-'}</small></td>
            <td><small>${reg.horario_texto || 'Sin horario'}</small></td>
            <td>${obtenerBadgeCodigo(reg.codigo_incidencia)}</td>
            <td><small>${movimientoTexto}</small></td>
            <td>${reg.checada1 || '-'}</td>
            <td>${reg.checada2 || '-'}</td>
            <td>${reg.checada3 || '-'}</td>
            <td>${reg.checada4 || '-'}</td>
            <td>${reg.minutos_retardo || 0}</td>
            <td>${reg.horas_trabajadas ? reg.horas_trabajadas.toFixed(2) : '0.00'}</td>
            <td><small>${reg.descripcion_incidencia || ''}</small></td>
        `;
        tbody.appendChild(tr);
    });
    
    // Guardar registros para PDF
    registrosProcesados = registros;
    
    // Obtener datos del trabajador seleccionado
    const selectTrabajador = document.getElementById('selectTrabajador');
    const selectedOption = selectTrabajador.options[selectTrabajador.selectedIndex];
    const nombreTrabajador = selectedOption ? selectedOption.text : '';
    const numTrabajador = document.getElementById('selectTrabajador').value;
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    datosGeneralesPDF = {
        nombre_trabajador: nombreTrabajador,
        num_trabajador: numTrabajador,
        fecha_inicio: fechaInicio,
        fecha_fin: fechaFin
    };
    
    // Mostrar botón de PDF apropiado según el modo
    if (modoMasivo) {
        document.getElementById('btnGenerarPDFMasivo').style.display = 'inline-block';
        document.getElementById('btnGenerarPDF').style.display = 'none';
    } else {
        document.getElementById('btnGenerarPDF').style.display = 'inline-block';
        document.getElementById('btnGenerarPDFMasivo').style.display = 'none';
    }
    
    document.getElementById('resultados').classList.remove('d-none');
}

function obtenerBadgeCodigo(codigo) {
    const badges = {
        'A': '<span class="badge bg-success">A</span>',
        'F': '<span class="badge bg-danger">F</span>',
        'R+': '<span class="badge bg-warning text-dark">R+</span>',
        'R-': '<span class="badge bg-warning text-dark">R-</span>',
        'O': '<span class="badge bg-secondary">O</span>',
        'ST': '<span class="badge bg-info text-dark">ST</span>',
        'J': '<span class="badge bg-primary">J</span>',
        'L': '<span class="badge bg-primary">L</span>'
    };
    return badges[codigo] || `<span class="badge bg-secondary">${codigo}</span>`;
}

async function generarPDF() {
    console.log('[BITACORA] Generando PDF...');
    
    if (!registrosProcesados || registrosProcesados.length === 0) {
        mostrarToast('No hay registros para generar PDF', 'warning');
        return;
    }
    
    const btnGenerarPDF = document.getElementById('btnGenerarPDF');
    btnGenerarPDF.disabled = true;
    btnGenerarPDF.innerHTML = '<i class="bi bi-hourglass-split"></i> Generando PDF...';
    
    try {
        const response = await fetch('/bitacora/generar-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                registros: registrosProcesados,
                nombre_trabajador: datosGeneralesPDF.nombre_trabajador,
                num_trabajador: datosGeneralesPDF.num_trabajador,
                fecha_inicio: datosGeneralesPDF.fecha_inicio,
                fecha_fin: datosGeneralesPDF.fecha_fin
            })
        });
        
        if (response.ok) {
            // Descargar PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Limpiar nombre del trabajador (quitar espacios, acentos, etc.)
            const nombreLimpio = datosGeneralesPDF.nombre_trabajador
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quitar acentos
                .replace(/\s+/g, '_') // Reemplazar espacios con guiones bajos
                .toLowerCase();
            
            a.download = 'bitacora_' + datosGeneralesPDF.num_trabajador + '_' + nombreLimpio + '_' + datosGeneralesPDF.fecha_inicio + '_' + datosGeneralesPDF.fecha_fin + '.pdf';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            mostrarToast('PDF generado exitosamente', 'success');
            console.log('[BITACORA] PDF descargado exitosamente');
        } else {
            const data = await response.json();
            mostrarToast(data.message || 'Error al generar PDF', 'error');
        }
    } catch (error) {
        console.error('[BITACORA] Error al generar PDF:', error);
        mostrarToast('Error al generar PDF', 'error');
    } finally {
        btnGenerarPDF.disabled = false;
        btnGenerarPDF.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> Descargar PDF Individual';
    }
}

// ===== FUNCIONES PARA REPORTE MASIVO =====

function mostrarSeleccionMasiva() {
    modoMasivo = true;
    document.getElementById('step1').classList.remove('show', 'active');
    document.getElementById('step1b').classList.add('show', 'active');
    cargarTrabajadoresMasivo();
}

function volverAIndividual() {
    modoMasivo = false;
    trabajadoresSeleccionados = [];
    horariosValidados = false; // Resetear validación
    document.getElementById('step1b').classList.remove('show', 'active');
    document.getElementById('step1').classList.add('show', 'active');
}

async function cargarTrabajadoresMasivo() {
    try {
        const response = await fetch('/trabajadores/listar');
        const data = await response.json();
        const trabajadores = data.trabajadores || data;
        
        const listaTrabajadores = document.getElementById('listaTrabajadoresMasivo');
        listaTrabajadores.innerHTML = '';
        
        if (trabajadores && Array.isArray(trabajadores)) {
            trabajadores.forEach(t => {
                const div = document.createElement('div');
                div.className = 'form-check trabajador-item';
                div.setAttribute('data-num', t.num_trabajador);
                div.setAttribute('data-nombre', (t.nombre || 'Sin nombre').toLowerCase());
                div.innerHTML = `
                    <input class="form-check-input trabajador-checkbox" type="checkbox" 
                           value="${t.num_trabajador}" id="check_${t.num_trabajador}"
                           onchange="actualizarSeleccion()">
                    <label class="form-check-label" for="check_${t.num_trabajador}">
                        ${t.num_trabajador} - ${t.nombre || 'Sin nombre'}
                    </label>
                `;
                listaTrabajadores.appendChild(div);
            });
            
            // Configurar el buscador
            const inputBuscar = document.getElementById('buscarTrabajadorMasivo');
            inputBuscar.addEventListener('input', filtrarTrabajadores);
        }
    } catch (error) {
        console.error('[BITACORA] Error cargando trabajadores masivo:', error);
    }
}

function filtrarTrabajadores() {
    const busqueda = document.getElementById('buscarTrabajadorMasivo').value.toLowerCase().trim();
    const items = document.querySelectorAll('.trabajador-item');
    
    let visibles = 0;
    items.forEach(item => {
        const num = item.getAttribute('data-num');
        const nombre = item.getAttribute('data-nombre');
        
        // Buscar por número o nombre
        if (num.includes(busqueda) || nombre.includes(busqueda)) {
            item.style.display = 'block';
            visibles++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Opcional: Mostrar mensaje si no hay resultados
    if (visibles === 0 && busqueda !== '') {
        console.log('[BITACORA] Sin resultados para:', busqueda);
    }
}

function seleccionarTodos() {
    // Solo selecciona los visibles (no ocultos por el filtro)
    document.querySelectorAll('.trabajador-item').forEach(item => {
        if (item.style.display !== 'none') {
            const checkbox = item.querySelector('.trabajador-checkbox');
            if (checkbox) {
                checkbox.checked = true;
            }
        }
    });
    actualizarSeleccion();
}

function deseleccionarTodos() {
    // Solo deselecciona los visibles (no ocultos por el filtro)
    document.querySelectorAll('.trabajador-item').forEach(item => {
        if (item.style.display !== 'none') {
            const checkbox = item.querySelector('.trabajador-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
        }
    });
    actualizarSeleccion();
}

function actualizarSeleccion() {
    trabajadoresSeleccionados = Array.from(document.querySelectorAll('.trabajador-checkbox:checked'))
        .map(cb => parseInt(cb.value));
    
    console.log('[BITACORA] Trabajadores seleccionados:', trabajadoresSeleccionados);
    
    const contador = document.getElementById('contadorSeleccionados');
    if (contador) {
        contador.textContent = trabajadoresSeleccionados.length;
    }
    
    const resumen = document.getElementById('resumenSeleccion');
    if (resumen) {
        if (trabajadoresSeleccionados.length > 0) {
            resumen.style.display = 'block';
        } else {
            resumen.style.display = 'none';
        }
    }
}

async function irAStep2Masivo() {
    console.log('[BITACORA] irAStep2Masivo - Trabajadores seleccionados:', trabajadoresSeleccionados);
    
    if (trabajadoresSeleccionados.length === 0) {
        mostrarToast('Debe seleccionar al menos un trabajador', 'warning');
        return;
    }
    
    console.log('[BITACORA] Avanzando a Step 2 con', trabajadoresSeleccionados.length, 'trabajadores');
    
    // Ocultar Step 1B y mostrar Step 2
    const step1b = document.getElementById('step1b');
    if (step1b) {
        step1b.classList.remove('show', 'active');
    }
    
    // Activar Step 2
    const step2Tab = document.getElementById('step2-tab');
    const step2 = document.getElementById('step2');
    
    if (step2Tab) {
        step2Tab.classList.remove('disabled');
    }
    
    if (step2) {
        step2.classList.add('show', 'active');
    }
    
    // Usar Bootstrap Tab para cambiar
    if (step2Tab) {
        const tab2 = new bootstrap.Tab(step2Tab);
        tab2.show();
    }
}

async function generarPDFMasivo() {
    console.log('[BITACORA] Generando PDF masivo para', trabajadoresSeleccionados.length, 'trabajadores');
    
    if (trabajadoresSeleccionados.length === 0) {
        mostrarToast('No hay trabajadores seleccionados', 'warning');
        return;
    }
    
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    if (!fechaInicio || !fechaFin) {
        mostrarToast('Debe especificar fechas', 'warning');
        return;
    }
    
    const btnGenerarPDFMasivo = document.getElementById('btnGenerarPDFMasivo');
    btnGenerarPDFMasivo.disabled = true;
    btnGenerarPDFMasivo.innerHTML = '<i class="bi bi-hourglass-split"></i> Generando PDF Masivo...';
    
    try {
        const response = await fetch('/bitacora/generar-pdf-masivo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                num_trabajadores: trabajadoresSeleccionados,
                fecha_inicio: fechaInicio,
                fecha_fin: fechaFin
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `registro_checadas_${trabajadoresSeleccionados.length}trabajadores_${fechaInicio}_${fechaFin}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            mostrarToast(`PDF masivo generado exitosamente (${trabajadoresSeleccionados.length} trabajadores)`, 'success');
            console.log('[BITACORA] PDF masivo descargado exitosamente');
        } else {
            const data = await response.json();
            mostrarToast(data.message || 'Error al generar PDF masivo', 'error');
        }
    } catch (error) {
        console.error('[BITACORA] Error al generar PDF masivo:', error);
        mostrarToast('Error al generar PDF masivo', 'error');
    } finally {
        btnGenerarPDFMasivo.disabled = false;
        btnGenerarPDFMasivo.innerHTML = '<i class="bi bi-file-earmark-pdf-fill"></i> Descargar PDF Masivo';
    }
}

function mostrarModalResultadosMasivos(resultados, totales, fechaInicio, fechaFin) {
    console.log('[BITACORA] Mostrando modal de resultados masivos');
    
    // Guardar fechas para descargas individuales
    window.fechasProcesamientoMasivo = { fechaInicio, fechaFin };
    
    // Actualizar resumen
    const resumenDetalle = document.getElementById('resumenMasivoDetalle');
    let htmlResumen = '<div class="row">';
    htmlResumen += '<div class="col-md-3"><strong>Trabajadores procesados:</strong> ' + totales.exitosos + '</div>';
    if (totales.fallidos > 0) {
        htmlResumen += '<div class="col-md-3 text-danger"><strong>Con errores:</strong> ' + totales.fallidos + '</div>';
    }
    htmlResumen += '<div class="col-md-3"><strong>Nuevos registros:</strong> ' + totales.insertados + '</div>';
    htmlResumen += '<div class="col-md-3"><strong>Actualizados:</strong> ' + totales.actualizados + '</div>';
    htmlResumen += '</div>';
    htmlResumen += '<div class="row mt-2">';
    htmlResumen += '<div class="col-md-12"><strong>Total de días procesados:</strong> ' + totales.total_registros + '</div>';
    htmlResumen += '</div>';
    resumenDetalle.innerHTML = htmlResumen;
    
    // Llenar tabla
    const tbody = document.getElementById('tbodyResultadosMasivos');
    tbody.innerHTML = '';
    
    resultados.forEach(resultado => {
        const tr = document.createElement('tr');
        
        // Estado con badge
        let badgeEstado = '';
        if (resultado.success) {
            badgeEstado = '<span class="badge bg-success">Exitoso</span>';
        } else {
            badgeEstado = '<span class="badge bg-danger">Error</span>';
        }
        
        // Crear celdas
        tr.innerHTML = '<td>' + resultado.num_trabajador + '</td>' +
                       '<td>' + resultado.nombre + '</td>' +
                       '<td>' + badgeEstado + '</td>' +
                       '<td>' + resultado.stats.insertados + '</td>' +
                       '<td>' + resultado.stats.actualizados + '</td>' +
                       '<td>' + resultado.total_registros + '</td>' +
                       '<td></td>'; // Celda vacía para acciones
        
        // Obtener la celda de acciones (última celda)
        const celdaAcciones = tr.lastElementChild;
        
        if (resultado.success && resultado.total_registros > 0) {
            // Botón PDF
            const btnPdf = document.createElement('button');
            btnPdf.className = 'btn btn-sm btn-primary me-1';
            btnPdf.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> PDF';
            btnPdf.onclick = function() {
                descargarPdfIndividualDesdeMasivo(resultado.num_trabajador, resultado.nombre);
            };
            celdaAcciones.appendChild(btnPdf);
            
            // Botón Enviar Correo
            const btnCorreo = document.createElement('button');
            btnCorreo.className = 'btn btn-sm btn-success';
            btnCorreo.innerHTML = '<i class="bi bi-envelope"></i> Enviar';
            btnCorreo.onclick = function() {
                enviarPorCorreo(resultado.num_trabajador, resultado.nombre);
            };
            celdaAcciones.appendChild(btnCorreo);
        } else if (!resultado.success) {
            const spanError = document.createElement('small');
            spanError.className = 'text-danger';
            spanError.textContent = resultado.error || 'Error desconocido';
            celdaAcciones.appendChild(spanError);
        } else {
            const spanNoData = document.createElement('small');
            spanNoData.className = 'text-muted';
            spanNoData.textContent = 'Sin registros';
            celdaAcciones.appendChild(spanNoData);
        }
        
        tbody.appendChild(tr);
    });
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalResultadosMasivos'));
    modal.show();
}

// ===== FUNCIONES PARA EDICIÓN DE REGISTROS =====

async function abrirModalEdicion(registroId) {
    console.log('[BITACORA] Abriendo modal de edición para registro:', registroId);
    
    try {
        const response = await fetch(`/bitacora/registro/${registroId}`);
        const data = await response.json();
        
        if (!data.success) {
            mostrarToast(data.message || 'Error al obtener registro', 'error');
            return;
        }
        
        const reg = data.registro;
        
        // Llenar campos del modal
        document.getElementById('editRegistroId').value = reg.id;
        document.getElementById('editNombreTrabajador').textContent = `${reg.num_trabajador} - ${reg.nombre_trabajador}`;
        document.getElementById('editFecha').textContent = reg.fecha;
        document.getElementById('editHorario').textContent = reg.horario_texto || 'Sin horario';
        
        // Incidencia actual
        document.getElementById('editCodigoActual').textContent = reg.codigo_incidencia;
        document.getElementById('editCodigoActual').className = 'badge ' + obtenerClaseBadge(reg.codigo_incidencia);
        document.getElementById('editTipoMovActual').textContent = reg.tipo_movimiento ? ` (${reg.tipo_movimiento})` : '';
        document.getElementById('editDescripcionActual').textContent = reg.descripcion_incidencia || '';
        
        // Checadas (convertir HH:MM:SS a HH:MM para input type="time")
        document.getElementById('editChecada1').value = formatTimeForInput(reg.checada1);
        document.getElementById('editChecada2').value = formatTimeForInput(reg.checada2);
        document.getElementById('editChecada3').value = formatTimeForInput(reg.checada3);
        document.getElementById('editChecada4').value = formatTimeForInput(reg.checada4);
        
        // Updatable (1 = true, 0 = false)
        document.getElementById('editUpdatable').checked = reg.updatable == 1 || reg.updatable === true;
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalEditarRegistro'));
        modal.show();
        
    } catch (error) {
        console.error('[BITACORA] Error abriendo modal de edición:', error);
        mostrarToast('Error al cargar el registro', 'error');
    }
}

function formatTimeForInput(timeStr) {
    if (!timeStr) return '';
    // Si viene como HH:MM:SS, extraer solo HH:MM
    const parts = timeStr.split(':');
    if (parts.length >= 2) {
        return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
    }
    return '';
}

function obtenerClaseBadge(codigo) {
    const clases = {
        'A': 'bg-success',
        'F': 'bg-danger',
        'R+': 'bg-warning text-dark',
        'R-': 'bg-warning text-dark',
        'O': 'bg-secondary',
        'ST': 'bg-info text-dark',
        'J': 'bg-primary',
        'L': 'bg-primary'
    };
    return clases[codigo] || 'bg-secondary';
}

async function guardarEdicionRegistro() {
    const registroId = document.getElementById('editRegistroId').value;
    const checada1 = document.getElementById('editChecada1').value || null;
    const checada2 = document.getElementById('editChecada2').value || null;
    const checada3 = document.getElementById('editChecada3').value || null;
    const checada4 = document.getElementById('editChecada4').value || null;
    const updatable = document.getElementById('editUpdatable').checked;
    
    console.log('[BITACORA] Guardando edición de registro:', registroId);
    console.log('[BITACORA] Datos:', { checada1, checada2, checada3, checada4, updatable });
    
    try {
        const response = await fetch(`/bitacora/registro/${registroId}/editar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                checada1: checada1,
                checada2: checada2,
                checada3: checada3,
                checada4: checada4,
                updatable: updatable
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Cerrar modal primero
            const modalElement = document.getElementById('modalEditarRegistro');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            // Limpiar backdrops por si acaso
            setTimeout(() => {
                limpiarBackdrops();
            }, 300);
            
            mostrarToast('Registro actualizado correctamente', 'success');
            
            // Actualizar la fila en la tabla
            actualizarFilaEnTabla(data.registro);
            
            // Actualizar registros procesados para PDF
            actualizarRegistroProcesado(data.registro);
            
        } else {
            mostrarToast(data.message || 'Error al actualizar registro', 'error');
        }
        
    } catch (error) {
        console.error('[BITACORA] Error guardando edición:', error);
        mostrarToast('Error al guardar cambios', 'error');
    }
}

function actualizarFilaEnTabla(registro) {
    const fila = document.querySelector(`tr[data-registro-id="${registro.id}"]`);
    if (!fila) return;
    
    // Columna Movimientos
    let movimientoTexto = '-';
    if (registro.codigo_incidencia === 'F' && registro.tipo_movimiento) {
        movimientoTexto = `<span class="badge bg-danger">${registro.tipo_movimiento}</span>`;
    } else if (registro.tipo_movimiento && (registro.codigo_incidencia === 'J' || registro.codigo_incidencia === 'L' || registro.codigo_incidencia === 'A')) {
        movimientoTexto = registro.tipo_movimiento;
    }
    
    fila.innerHTML = `
        <td><strong>${obtenerDiaSemana(registro.fecha)}</strong> ${registro.fecha}</td>
        <td><small>${registro.departamento || '-'}</small></td>
        <td><small>${registro.horario_texto || 'Sin horario'}</small></td>
        <td>${obtenerBadgeCodigo(registro.codigo_incidencia)}</td>
        <td><small>${movimientoTexto}</small></td>
        <td>${registro.checada1 || '-'}</td>
        <td>${registro.checada2 || '-'}</td>
        <td>${registro.checada3 || '-'}</td>
        <td>${registro.checada4 || '-'}</td>
        <td>${registro.minutos_retardo || 0}</td>
        <td>${registro.horas_trabajadas ? registro.horas_trabajadas.toFixed(2) : '0.00'}</td>
        <td><small>${registro.descripcion_incidencia || ''}</small></td>
    `;
    
    // Reasignar el evento de doble click
    fila.addEventListener('dblclick', function() {
        abrirModalEdicion(registro.id);
    });
    
    // Resaltar la fila brevemente
    fila.style.backgroundColor = '#d4edda';
    setTimeout(() => {
        fila.style.backgroundColor = '';
    }, 2000);
}

function actualizarRegistroProcesado(registroActualizado) {
    // Actualizar el array global de registros procesados para PDF
    if (registrosProcesados && Array.isArray(registrosProcesados)) {
        const index = registrosProcesados.findIndex(r => r.id === registroActualizado.id);
        if (index !== -1) {
            registrosProcesados[index] = registroActualizado;
        }
    }
}

async function descargarPdfIndividualDesdeMasivo(numTrabajador, nombreTrabajador) {
    console.log('[BITACORA] Descargando PDF individual para trabajador:', numTrabajador);
    
    const fechas = window.fechasProcesamientoMasivo;
    if (!fechas) {
        mostrarToast('Error: No se encontraron las fechas de procesamiento', 'error');
        return;
    }
    
    try {
        // Primero obtener los registros procesados
        const listarResponse = await fetch('/bitacora/listar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                num_trabajador: numTrabajador,
                fecha_inicio: fechas.fechaInicio,
                fecha_fin: fechas.fechaFin
            })
        });
        
        const listarData = await listarResponse.json();
        
        if (!listarData.success || !listarData.registros || listarData.registros.length === 0) {
            mostrarToast('No se encontraron registros para este trabajador', 'warning');
            return;
        }
        
        // Generar PDF
        const pdfResponse = await fetch('/bitacora/generar-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                registros: listarData.registros,
                nombre_trabajador: nombreTrabajador,
                num_trabajador: numTrabajador,
                fecha_inicio: fechas.fechaInicio,
                fecha_fin: fechas.fechaFin
            })
        });
        
        if (pdfResponse.ok) {
            const blob = await pdfResponse.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Limpiar nombre del trabajador
            const nombreLimpio = nombreTrabajador
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quitar acentos
                .replace(/\s+/g, '_') // Reemplazar espacios con guiones bajos
                .toLowerCase();
            
            a.download = 'bitacora_' + numTrabajador + '_' + nombreLimpio + '_' + fechas.fechaInicio + '_' + fechas.fechaFin + '.pdf';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            mostrarToast('PDF descargado exitosamente', 'success');
        } else {
            const errorData = await pdfResponse.json();
            mostrarToast(errorData.message || 'Error al generar PDF', 'error');
        }
        
    } catch (error) {
        console.error('[BITACORA] Error descargando PDF individual:', error);
        mostrarToast('Error al descargar PDF', 'error');
    }
}

async function enviarPorCorreo(numTrabajador, nombreTrabajador) {
    console.log('[BITACORA] Enviando correo para trabajador:', numTrabajador);
    
    const fechas = window.fechasProcesamientoMasivo;
    if (!fechas) {
        mostrarToast('Error: No se encontraron las fechas de procesamiento', 'error');
        return;
    }
    
    try {
        // Mostrar indicador de carga
        mostrarToast('Enviando correo...', 'info');
        
        // Llamar al endpoint para enviar el correo
        const response = await fetch('/bitacora/enviar-correo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                num_trabajador: numTrabajador,
                nombre_trabajador: nombreTrabajador,
                fecha_inicio: fechas.fechaInicio,
                fecha_fin: fechas.fechaFin
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast(data.message || 'Correo enviado exitosamente', 'success');
        } else {
            mostrarToast(data.message || 'Error al enviar correo', 'error');
        }
        
    } catch (error) {
        console.error('[BITACORA] Error enviando correo:', error);
        mostrarToast('Error al enviar correo', 'error');
    }
}

function mostrarToast(mensaje, tipo) {
    // Limpiar backdrops huérfanos primero
    limpiarBackdrops();
    
    // Crear toast container si no existe
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Mapear tipo a clase de Bootstrap
    const bgClass = {
        'success': 'bg-success text-white',
        'error': 'bg-danger text-white',
        'warning': 'bg-warning text-dark',
        'info': 'bg-info text-dark'
    }[tipo] || 'bg-info text-dark';
    
    // Crear toast
    const toastId = 'toast_' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast ${bgClass}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${mensaje}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
    toast.show();
    
    // Eliminar el elemento después de que se oculte
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Función para limpiar backdrops huérfanos de modales
function limpiarBackdrops() {
    // Eliminar backdrops huérfanos
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.remove();
    });
    
    // Restaurar scroll del body
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
}

// Agregar listeners para limpiar al cerrar modales
document.addEventListener('DOMContentLoaded', function() {
    // Limpiar backdrops cuando se oculten los modales
    const modales = ['modalEditarRegistro', 'modalResultadosMasivos'];
    
    modales.forEach(modalId => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            modalElement.addEventListener('hidden.bs.modal', function() {
                limpiarBackdrops();
            });
        }
    });
});
</script>
{% endblock %}
