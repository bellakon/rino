<!-- Modal: Asignar Plantilla a Trabajador -->
<div class="modal fade" id="modalAsignarDesdePlantilla" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-check"></i> Asignar Horario a Trabajador
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <strong>Plantilla seleccionada:</strong> <span id="nombrePlantillaAsignar"></span>
                </div>

                <form id="formAsignarDesdePlantilla">
                    <input type="hidden" id="asignar_plantilla_id" name="plantilla_horario_id">

                    <div class="mb-3">
                        <label class="form-label">Trabajador *</label>
                        <select class="form-select" id="asignar_num_trabajador" name="num_trabajador" required>
                            <option value="">Cargando trabajadores...</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Fecha Inicio *</label>
                            <input type="date" class="form-control" id="asignar_fecha_inicio" name="fecha_inicio_asignacion" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha Fin *</label>
                            <input type="date" class="form-control" id="asignar_fecha_fin" name="fecha_fin_asignacion" required>
                        </div>
                    </div>

                    <div class="mb-3 mt-3">
                        <label class="form-label">Semestre *</label>
                        <select class="form-select" id="asignar_semestre" name="semestre" required>
                            <option value="">Seleccionar...</option>
                            {% for semestre in semestres %}
                            <option value="{{ semestre }}">{{ semestre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="asignar_estado" name="estado_asignacion">
                            <option value="activo">Activo</option>
                            <option value="finalizado">Finalizado</option>
                            <option value="suspendido">Suspendido</option>
                        </select>
                    </div>
                </form>

                <div id="resultadoAsignacion" class="mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="guardarAsignacionDesdePlantilla()">
                    <i class="bi bi-check-circle"></i> Asignar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Cargar trabajadores cuando se abre el modal
document.getElementById('modalAsignarDesdePlantilla').addEventListener('show.bs.modal', () => {
    cargarTrabajadoresParaAsignar();
});

function cargarTrabajadoresParaAsignar() {
    console.log('[MODAL ASIGNAR DESDE] Cargando trabajadores...');
    fetch('/trabajadores/listar?activo=true')
        .then(r => r.json())
        .then(data => {
            console.log('[MODAL ASIGNAR DESDE] Respuesta:', data);
            const select = document.getElementById('asignar_num_trabajador');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            if (data.trabajadores && data.trabajadores.length > 0) {
                console.log(`[MODAL ASIGNAR DESDE] ${data.trabajadores.length} trabajadores encontrados`);
                data.trabajadores.forEach(t => {
                    select.innerHTML += `<option value="${t.num_trabajador}">${t.num_trabajador} - ${t.nombre}</option>`;
                });
            } else {
                select.innerHTML = '<option value="">No hay trabajadores activos</option>';
                console.warn('[MODAL ASIGNAR DESDE] No se encontraron trabajadores');
            }
        })
        .catch(err => {
            console.error('[MODAL ASIGNAR DESDE] Error cargando trabajadores:', err);
            const select = document.getElementById('asignar_num_trabajador');
            select.innerHTML = '<option value="">Error al cargar trabajadores</option>';
        });
}

function abrirModalAsignarDesde(plantillaId, nombrePlantilla) {
    console.log(`[ASIGNAR DESDE] Plantilla ID: ${plantillaId}, Nombre: ${nombrePlantilla}`);
    
    // Guardar ID de plantilla
    document.getElementById('asignar_plantilla_id').value = plantillaId;
    
    // Mostrar nombre de plantilla
    document.getElementById('nombrePlantillaAsignar').textContent = nombrePlantilla;
    
    // Limpiar formulario
    document.getElementById('formAsignarDesdePlantilla').reset();
    document.getElementById('asignar_plantilla_id').value = plantillaId; // Restaurar después del reset
    document.getElementById('resultadoAsignacion').style.display = 'none';
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalAsignarDesdePlantilla'));
    modal.show();
}

function guardarAsignacionDesdePlantilla() {
    const form = document.getElementById('formAsignarDesdePlantilla');
    
    // Validar formulario
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Validar fechas
    const fechaInicio = document.getElementById('asignar_fecha_inicio').value;
    const fechaFin = document.getElementById('asignar_fecha_fin').value;
    
    if (!fechaInicio) {
        alert('La fecha de inicio es obligatoria');
        return;
    }
    
    if (!fechaFin) {
        alert('La fecha fin es obligatoria');
        return;
    }
    
    if (fechaFin < fechaInicio) {
        alert('La fecha fin no puede ser anterior a la fecha de inicio');
        return;
    }
    
    const datos = {
        plantilla_horario_id: parseInt(document.getElementById('asignar_plantilla_id').value),
        num_trabajador: parseInt(document.getElementById('asignar_num_trabajador').value),
        fecha_inicio_asignacion: fechaInicio,
        fecha_fin_asignacion: fechaFin,
        semestre: document.getElementById('asignar_semestre').value,
        estado_asignacion: document.getElementById('asignar_estado').value
    };
    
    console.log('[ASIGNAR DESDE] Datos a enviar:', datos);
    
    // Mostrar loading
    const resultadoDiv = document.getElementById('resultadoAsignacion');
    resultadoDiv.style.display = 'block';
    resultadoDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Guardando...</span>
            </div>
            <p class="mt-2">Asignando horario...</p>
        </div>
    `;
    
    fetch('/horarios/asignaciones/crear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(datos)
    })
    .then(r => r.json())
    .then(data => {
        console.log('[ASIGNAR DESDE] Respuesta del servidor:', data);
        
        if (data.error) {
            resultadoDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong><i class="bi bi-exclamation-triangle"></i> Error:</strong><br>
                    ${data.error}
                </div>
            `;
        } else {
            resultadoDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong><i class="bi bi-check-circle"></i> ¡Éxito!</strong><br>
                    ${data.mensaje}
                </div>
            `;
            
            // Recargar tabla de asignaciones después de 1.5 segundos
            setTimeout(() => {
                cargarAsignaciones();
                bootstrap.Modal.getInstance(document.getElementById('modalAsignarDesdePlantilla')).hide();
            }, 1500);
        }
    })
    .catch(err => {
        console.error('[ASIGNAR DESDE] Error:', err);
        resultadoDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong><i class="bi bi-exclamation-triangle"></i> Error:</strong><br>
                ${err.message}
            </div>
        `;
    });
}
</script>
